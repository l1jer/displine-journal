## 操作系统的运行环境

### 操作系统的运行机制

__内核(Kernal)__是操作系统最核心的部分, 由很多内核程序组成操作系统内核

__应用程序__ -> 非特权指令 //加减法指令  
__内核程序__ -> 特权指令  

__内核态__ -> 内核程序运行中, 可执行特权指令  
__用户态__ -> 应用程序运行中, 只可以执行非特性指令  
CPU 中有一个寄存器叫`程序状态字寄存器(PSW)`

* 1:内核态/核心态/管态;
* 0:用户态/目态.  

__内核态 -> 用户态__: 执行一条特权指令进而修改PSW标志位为用户态,意味着OS将主动让出CPU使用权.  
__用户态 -> 内核态__: 由"中断"引发, 硬件自动完成变态过程, 触发`中断信号`(此信号每次出现意味着操作系统需要介入)意味着操作系统将强行夺回 CPU 的使用权.  



### 中断与异常

#### __中断的作用__

CPU 上会运行操作 `系统内核程序` 和 `应用程序` 两种; 是唯一能让操作系统内核夺回 CPU 使用权的途径, 如若没有它, 那么 CPU 会一直运行应用程序.



#### __中断的类型__

* 内中断(异常/例外): 与当前执行指令有关, 中断信号来源于 CPU 内部;
  * `陷入/陷阱指令 trap`:应用程序主动交还 CPU 控制权给操作系统内核, `系统调用`就是通过`陷入指令`来完成的, 由应用程序故意引发的.
  * `故障 fault`: 由错误条件引起, 可能会被内核程序修复; 修复后会把 CPU 使用权还给应用程序使其继续运行, 如打印机缺页故障
  * `终止 abort`: 由致命错误引起, 内核程序无法修复, 因此不再将 CPU 使用权还给引发终止的应用程序, 而是直接终止此程序, 如非法使用特权指令
* 外中断(中断): 与当前执行指令无关, 中断信号来源于 CPU 外部.
  * 时钟中断: 由时钟部件发来中断信号(每隔一段时间会给 CPU 发送一个中断信号).
  * I/O 中断请求: 由输入/输出设备发来的中断信号, 由 CPU 处理 I/O 中断的内核程序来执行.
  * 

#### __中断机制的基本原理__

* 不同的中断信号, 需要用不同的中断处理程序来处理
  1. 检查中断信号
     * 内中断: CPU 在执行指令时会检查是否有异常发生;
     * 外中断: 每个指令周期末尾, CPU 都会检查是否有外中断信号需要处理.
     
  2. 找到相应的中断处理程序 -> 通过"中断向量表"实现
  
     

### 系统调用

#### 概念 Concept

程序接口由系统调用组成, 是操作系统提供给应用程序使用的接口, 一种可供应用程序调用的特殊函数, 应用程序可通过它来请求获得操作系统内核的服务.



#### 与库函数的区别:

* `普通应用程序`: 两者皆可直接使用, 库函数有涉及和不涉及系统调用的部分;

* `编程语言`: 向上提供库函数; 有时会将系统调用封装成库函数, 以移仓系统调用的部分细节, 使程序员编程更加方便;

* `操作系统`:  向上提供系统调用, 使得上层程序能请求内和服务.

  > 不涉及系统调用的库函数: '取绝对值' 的函数;
  >
  > 涉及系统调用的库函数: '创建一个新文件' 的函数.



#### 系统调用的功能实现

设备管理; 文件管理; 进程控制; 进程通信; 内存管理 

凡是与共享资源有关的操作/会直接影响到其他进程的操作, 就一定需要操作系统介入, 即系统调用来实现.



#### 系统调用过程

传送系统调用参数 >> 执行陷入指令(用户态) >> 执行相应的内请求核成序处理系统调用(核心态) >> 返回应用程序 

![image-20200317002234616](/Users/jerry/Library/Application Support/typora-user-images/image-20200317002234616.png)

> 1. 在__用户态__中执行__陷入指令__, 在此之后立即引发一个**内中断**, 使CPU 进入**核心态**;
> 2. 在**用户态**中发出**系统调用**请求, 在**核心态**下进行对**系统调用的相应处理**



### 操作系统的体系结构

__大内核/单内核/宏内核__: 把所有操作功能保留在内核中, 包括`进程管理,存储器管理和设备管理等功能`和`始终管理,中断处理以及原语(设备驱动/CPU 切换等)`.

__微内核__: 只保留与硬件接触最紧密的部分, 即`始终管理,中断处理以及原语(设备驱动/CPU 切换等)`, 其余部分(`进程管理,存储器管理和设备管理等功能`)就会运行在用户态.

|  重点  | Strength                     | Weakness                           |
| :----: | ---------------------------- | ---------------------------------- |
| 大内核 | 高性能                       | 内核复杂, 结构混乱, 难以维护       |
| 微内核 | 内核简约, 结构清晰, 方便维护 | 低性能(需要频繁切换用户态和核心态) |

